name: autofix

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install stable Rust (with rustfmt)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Install Taplo (TOML formatter)
        uses: uncenter/setup-taplo@v1
        with:
          version: "0.8.1"

      # --- 1. Detect CR-only line endings (before conversion) ---
      - name: Debug newline bytes (Cargo.toml)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          p = Path("Cargo.toml")
          if p.exists():
              data = p.read_bytes()
              print(f"Cargo.toml: \\n = {data.count(b'\\n')}, \\r = {data.count(b'\\r')}")
              print("First 120 bytes (hex):", data[:120].hex())
          else:
              print("⚠️ Cargo.toml not found")
          PY

      # --- 2. Convert CR-only → LF (tracked files only) ---
      - name: Convert CR-only line endings to LF (tracked files)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import subprocess
          from pathlib import Path

          TEXT_EXT = {".rs",".toml",".yml",".yaml",".md",".txt",".json",".lock"}
          ALWAYS = {"Cargo.toml","Cargo.lock",".gitattributes","README.md"}

          out = subprocess.check_output(["git","ls-files","-z"])
          files = [p for p in out.split(b"\0") if p]

          changed = []
          for b in files:
              p = Path(b.decode("utf-8", "surrogateescape"))
              if p.name in ALWAYS or p.suffix.lower() in TEXT_EXT:
                  data = p.read_bytes()
                  if b"\r" in data and b"\n" not in data:
                      p.write_bytes(data.replace(b"\r", b"\n"))
                      changed.append(str(p))

          print(f"Converted {len(changed)} file(s) from CR-only to LF")
          for x in changed[:200]:
              print(" -", x)
          PY

      # --- 3. Verify .gitattributes exists (fail fast if missing) ---
      - name: Verify .gitattributes exists and enforces LF
        run: |
          set -euo pipefail
          test -f .gitattributes
          grep -q 'text=auto eol=lf' .gitattributes

      # --- 4. Apply git renormalization (CRLF↔LF) ---
      - name: Normalize line endings (LF)
        run: |
          set -euo pipefail
          git add --renormalize . || true
          echo "After renormalize:"
          git status --porcelain || true

      # --- 5. Apply formatters ---
      - name: Rustfmt (apply)
        run: cargo fmt

      - name: Taplo fmt (apply)
        run: taplo fmt

      # --- 6. Stage ALL changes explicitly ---
      - name: Stage changes
        run: git add -A

      # --- 7. Final verification ---
      - name: Final debug summary
        run: |
          set -euo pipefail
          echo "=== Final Git status ==="
          git status --porcelain
          echo ""
          echo "=== Final Git diff stat ==="
          git diff --stat --cached
          echo ""
          echo "=== Cargo.toml newline check (post-fix) ==="
          python3 - <<'PY'
          from pathlib import Path
          p = Path("Cargo.toml")
          if p.exists():
              data = p.read_bytes()
              print(f"Cargo.toml: \\n = {data.count(b'\\n')}, \\r = {data.count(b'\\r')}")
          PY

      # --- 8. Create PR if changes exist ---
      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: fix CR-only line endings + formatting"
          title: "chore: fix CR-only line endings + formatting"
          body: |
            Automated fixes:
            - Converted classic Mac CR-only line endings → LF
            - Applied git renormalization (.gitattributes)
            - cargo fmt + taplo fmt

            This resolves GitHub Raw showing files as "1 line".
          branch: autofix/formatting
          delete-branch: true

