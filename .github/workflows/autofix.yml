name: autofix

on:
  workflow_dispatch: # Change to 'push' if you want it automatic, but see note below
  # push:
  #   branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # If using 'push' trigger, you might need a PAT here to trigger subsequent workflows
          # token: ${{ secrets.PAT }} 

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Install Taplo
        uses: uncenter/setup-taplo@v1
        with:
          version: "0.8.1"

      # 1. Ensure .gitattributes exists with LF policy
      - name: Enforce .gitattributes
        run: |
          if [ ! -f .gitattributes ]; then
            echo "* text=auto eol=lf" > .gitattributes
            echo "*.png binary" >> .gitattributes
            echo "*.jpg binary" >> .gitattributes
          fi

      # 2. Normalize line endings based on the file above
      - name: Normalize line endings
        run: |
          git add .gitattributes
          git add --renormalize .
          # Optional: Verify changes occurred
          git diff --cached --stat || true

      - name: Rustfmt
        run: cargo fmt

      - name: Taplo fmt
        run: taplo fmt

      # REMOVED: cargo fix (Too dangerous for automation)

      - name: Debug diffs
        run: |
          echo "Git status:"
          git status --porcelain
          echo "Git diff stat:"
          git diff --stat

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: autofix formatting and line endings"
          title: "chore: autofix formatting and line endings"
          body: |
            Automated maintenance:
            - Enforced LF line endings via .gitattributes
            - cargo fmt
            - taplo fmt
          branch: autofix/formatting
          delete-branch: true
          # If you switch to 'push' trigger, add this to prevent loops:
          # token: ${{ secrets.PAT }} 

