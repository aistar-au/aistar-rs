name: autofix

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install stable Rust (with rustfmt)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Install Taplo (TOML formatter)
        uses: uncenter/setup-taplo@v1
        with:
          version: "0.8.1"

      # --- 1. Diagnose line ending situation ---
      - name: Debug newline bytes (Cargo.toml)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          p = Path("Cargo.toml")
          if p.exists():
              data = p.read_bytes()
              nl = data.count(b'\n')
              cr = data.count(b'\r')
              print(f"Cargo.toml: size={len(data)} bytes, \\n = {nl}, \\r = {cr}")
              if nl == 0 and cr == 0:
                  print("⚠️  NO LINE BREAKS DETECTED - file has no terminators!")
              elif cr > 0 and nl == 0:
                  print("⚠️  CR-only line endings (classic Mac)")
              elif cr > 0 and nl > 0:
                  print("⚠️  Mixed line endings (CRLF)")
              else:
                  print("✅ Line endings look normal (LF)")
              print("First 200 bytes (hex):", data[:200].hex())
              print("First 200 bytes (repr):", repr(data[:200]))
          else:
              print("⚠️  Cargo.toml not found")
          PY

      # --- 2. Fix files with NO line breaks OR CR-only ---
      - name: Fix line endings (no breaks + CR-only → LF)
        id: fixlines
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import subprocess
          from pathlib import Path

          TEXT_EXT = {".rs",".toml",".yml",".yaml",".md",".txt",".json",".lock"}
          ALWAYS = {"Cargo.toml","Cargo.lock",".gitattributes","README.md"}

          out = subprocess.check_output(["git","ls-files","-z"])
          files = [p for p in out.split(b"\0") if p]

          changed = []
          for b in files:
              p = Path(b.decode("utf-8", "surrogateescape"))
              if p.name in ALWAYS or p.suffix.lower() in TEXT_EXT:
                  try:
                      data = p.read_bytes()
                      if len(data) == 0:
                          continue  # Skip empty files
                      
                      nl = data.count(b'\n')
                      cr = data.count(b'\r')
                      
                      modified = None
                      
                      # Case 1: No line breaks at all - add LF at end
                      if nl == 0 and cr == 0:
                          if not data.endswith(b'\n'):
                              modified = data + b'\n'
                          
                      # Case 2: CR-only (classic Mac) - convert to LF
                      elif cr > 0 and nl == 0:
                          modified = data.replace(b'\r', b'\n')
                          if not modified.endswith(b'\n'):
                              modified += b'\n'
                          
                      # Case 3: CRLF - convert to LF
                      elif b'\r\n' in data:
                          modified = data.replace(b'\r\n', b'\n').replace(b'\r', b'\n')
                      
                      if modified is not None and modified != data:
                          p.write_bytes(modified)
                          changed.append(str(p))
                  except Exception as e:
                      print(f"⚠️  Skipping {p}: {e}")

          print(f"\n✅ Fixed {len(changed)} file(s)")
          for x in sorted(changed)[:200]:
              print(" -", x)
          
          with open(Path.home() / "fix_count.txt", "w") as f:
              f.write(str(len(changed)))
          PY

      # --- 3. Verify .gitattributes exists ---
      - name: Verify .gitattributes exists and enforces LF
        run: |
          set -euo pipefail
          if [ ! -f .gitattributes ]; then
            echo "::error::.gitattributes not found!"
            exit 1
          fi
          if ! grep -q 'text=auto eol=lf' .gitattributes; then
            echo "::error::.gitattributes doesn't enforce LF!"
            exit 1
          fi
          echo "✅ .gitattributes verified"

      # --- 4. Apply git renormalization ---
      - name: Normalize line endings (LF)
        run: |
          set -euo pipefail
          git add --renormalize . || true

      # --- 5. Apply formatters ---
      - name: Rustfmt (apply)
        run: cargo fmt

      - name: Taplo fmt (apply)
        run: taplo fmt

      # --- 6. Stage ALL changes ---
      - name: Stage changes
        run: git add -A

      # --- 7. Final verification ---
      - name: Final debug summary
        run: |
          set -euo pipefail
          echo "=== Final Git status ==="
          git status --porcelain
          echo ""
          echo "=== Final Git diff stat (cached) ==="
          git diff --cached --stat
          echo ""
          echo "=== Cargo.toml newline check (post-fix) ==="
          python3 - <<'PY'
          from pathlib import Path
          p = Path("Cargo.toml")
          if p.exists():
              data = p.read_bytes()
              print(f"Cargo.toml: size={len(data)} bytes, \\n = {data.count(b'\\n')}, \\r = {data.count(b'\\r')}")
          PY
          
          CHANGED=$(git status -s | wc -l)
          FIX_COUNT=$(cat $HOME/fix_count.txt 2>/dev/null || echo "0")
          
          echo ""
          echo "=== Summary ==="
          echo "Files fixed: $FIX_COUNT"
          echo "Total git changes: $CHANGED"
          
          if [ "$CHANGED" -eq 0 ]; then
            echo "::warning::No changes detected"
          fi

      # --- 8. Create PR ---
      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: fix line endings + formatting"
          title: "chore: fix line endings + formatting"
          body: |
            Automated fixes:
            - Added missing line terminators (LF)
            - Converted CR-only/CRLF → LF
            - Applied git renormalization
            - cargo fmt + taplo fmt
          branch: autofix/formatting
          delete-branch: true

